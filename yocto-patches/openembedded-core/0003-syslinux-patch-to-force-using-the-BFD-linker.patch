From 602826d923e137a87d69af49f7f79109079372c8 Mon Sep 17 00:00:00 2001
From: Allen Wild <allenwild93@gmail.com>
Date: Sun, 17 Dec 2017 20:51:28 -0500
Subject: [PATCH] syslinux: patch to force using the BFD linker

---
 .../syslinux-link-with-gcc-wrapper.patch      | 240 ++++++++++++++++++
 .../syslinux/syslinux_6.04-pre2.bb            |   5 +-
 2 files changed, 243 insertions(+), 2 deletions(-)
 create mode 100644 meta/recipes-devtools/syslinux/syslinux/syslinux-link-with-gcc-wrapper.patch

diff --git a/meta/recipes-devtools/syslinux/syslinux/syslinux-link-with-gcc-wrapper.patch b/meta/recipes-devtools/syslinux/syslinux/syslinux-link-with-gcc-wrapper.patch
new file mode 100644
index 0000000000..40ff96f4a4
--- /dev/null
+++ b/meta/recipes-devtools/syslinux/syslinux/syslinux-link-with-gcc-wrapper.patch
@@ -0,0 +1,240 @@
+From 7072eddb4a1334f5d35ee6aad0152278bcb6619b Mon Sep 17 00:00:00 2001
+From: Allen Wild <allenwild93@gmail.com>
+Date: Sat, 16 Dec 2017 13:38:54 -0500
+Subject: [PATCH] syslinux: link with gcc wrapper
+
+Syslinux fails at runtime if the GNU Gold linker is used, Gold is the
+default "ld" linker in some distributions.
+
+Force the BFD linker by using LD='gcc -nostdlib -fuse-ld=bfd' and adding
+-Wl in front of LDFLAGS entries as needed
+---
+ Makefile                       | 4 ++--
+ com32/cmenu/Makefile           | 2 +-
+ com32/elflink/Makefile         | 2 +-
+ com32/elflink/ldlinux/Makefile | 4 ++--
+ com32/gpllib/Makefile          | 2 +-
+ com32/lib/Makefile             | 2 +-
+ com32/libutil/Makefile         | 2 +-
+ com32/lua/src/Makefile         | 2 +-
+ core/Makefile                  | 4 ++--
+ memdisk/Makefile               | 4 ++--
+ mk/com32.mk                    | 2 +-
+ mk/elf.mk                      | 2 +-
+ mk/embedded.mk                 | 2 +-
+ mk/lib.mk                      | 2 +-
+ mk/syslinux.mk                 | 2 +-
+ 15 files changed, 19 insertions(+), 19 deletions(-)
+
+Index: syslinux-6.04-pre2/Makefile
+===================================================================
+--- syslinux-6.04-pre2.orig/Makefile
++++ syslinux-6.04-pre2/Makefile
+@@ -205,7 +205,7 @@ INSTALL_AUX   =	core/pxelinux.0 \
+ 		core/isolinux.bin core/isolinux-debug.bin \
+ 		dos/syslinux.com core/lpxelinux.0 \
+ 		mbr/*.bin $(INSTALLABLE_MODULES)
+-INSTALL_AUX_OPT = win32/syslinux.exe win64/syslinux64.exe
++INSTALL_AUX_OPT =  win64/syslinux64.exe
+ INSTALL_DIAG  =	diag/mbr/handoff.bin \
+ 		diag/geodsp/geodsp1s.img.xz diag/geodsp/geodspms.img.xz
+ 
+Index: syslinux-6.04-pre2/com32/cmenu/Makefile
+===================================================================
+--- syslinux-6.04-pre2.orig/com32/cmenu/Makefile
++++ syslinux-6.04-pre2/com32/cmenu/Makefile
+@@ -49,7 +49,7 @@ makeoutputdirs:
+ 	@mkdir -p $(OBJ)/libmenu
+ 
+ libmenu/libmenu.elf: $(LIBMENU)
+-	$(LD) -shared $(LDFLAGS) -soname $(patsubst %.elf,%.c32,$(@F)) \
++	$(LD) -shared $(LDFLAGS) -Wl,-soname $(patsubst %.elf,%.c32,$(@F)) \
+ 		-o $@ $^
+ 
+ tidy dist:
+Index: syslinux-6.04-pre2/com32/elflink/Makefile
+===================================================================
+--- syslinux-6.04-pre2.orig/com32/elflink/Makefile
++++ syslinux-6.04-pre2/com32/elflink/Makefile
+@@ -20,7 +20,7 @@ test_memalign.elf : test_memalign.o  $(L
+ 
+ test_com32.elf: CFLAGS += -DELF_DEBUG
+ test_com32.elf: test_com32.o ../lib/libcom32min.a $(LIBGCC)
+-	$(LD) -n $(LDFLAGS) -o $@ test_com32.o $(LIBGCC) --whole-archive ../lib/libcom32min.a -Map test_com32.map
++	$(LD) -n $(LDFLAGS) -o $@ test_com32.o $(LIBGCC) -Wl,--whole-archive ../lib/libcom32min.a -Wl,-Map,test_com32.map
+ 
+ tidy dist:
+ 	rm -f *.o *.lo *.a *.lst *.elf .*.d *.map
+Index: syslinux-6.04-pre2/com32/elflink/ldlinux/Makefile
+===================================================================
+--- syslinux-6.04-pre2.orig/com32/elflink/ldlinux/Makefile
++++ syslinux-6.04-pre2/com32/elflink/ldlinux/Makefile
+@@ -14,7 +14,7 @@ VPATH = $(SRC)
+ include $(MAKEDIR)/elf.mk
+ 
+ CFLAGS += -I$(topdir)/core/elflink -I$(topdir)/core/include -I$(topdir)/com32/lib -fvisibility=hidden
+-LIBS = --whole-archive $(objdir)/com32/lib/libcom32min.a
++LIBS = -Wl,--whole-archive $(objdir)/com32/lib/libcom32min.a
+ 
+ OBJS = ldlinux.o cli.o readconfig.o refstr.o colors.o getadv.o adv.o \
+ 	execute.o chainboot.o kernel.o get_key.o advwrite.o setadv.o \
+@@ -33,7 +33,7 @@ endif
+ all: $(BTARGET) ldlinux_lnx.a
+ 
+ ldlinux.elf : $(OBJS)
+-	$(LD) $(LDFLAGS) -soname $(SONAME) -o $@ $^ $(LIBS)
++	$(LD) $(LDFLAGS) -Wl,-soname $(SONAME) -o $@ $^ $(LIBS)
+ 
+ LNXCFLAGS += -D__export='__attribute__((visibility("default")))'
+ LNXLIBOBJS = get_key.lo
+Index: syslinux-6.04-pre2/com32/gpllib/Makefile
+===================================================================
+--- syslinux-6.04-pre2.orig/com32/gpllib/Makefile
++++ syslinux-6.04-pre2/com32/gpllib/Makefile
+@@ -24,7 +24,7 @@ makeoutputdirs:
+ 		$(addprefix $(OBJ),$(sort $(dir $(LIBOBJS)))),$(b))
+ 
+ libgpl.elf : $(LIBOBJS)
+-	$(LD) -shared $(LDFLAGS) -soname $(patsubst %.elf,%.c32,$(@F)) -o $@ $^
++	$(LD) -shared $(LDFLAGS) -Wl,-soname $(patsubst %.elf,%.c32,$(@F)) -o $@ $^
+ 
+ tidy dist clean:
+ 	find . \( -name \*.o -o -name .\*.d -o -name \*.tmp \) -print0 | \
+Index: syslinux-6.04-pre2/com32/lib/Makefile
+===================================================================
+--- syslinux-6.04-pre2.orig/com32/lib/Makefile
++++ syslinux-6.04-pre2/com32/lib/Makefile
+@@ -90,7 +90,7 @@ makeoutputdirs:
+ 
+ libcom32.elf : $(LIBOBJS)
+ 	rm -f $@
+-	$(LD) -shared $(LDFLAGS) -soname $(patsubst %.elf,%.c32,$(@F)) -o $@ $^
++	$(LD) -shared $(LDFLAGS) -Wl,-soname $(patsubst %.elf,%.c32,$(@F)) -o $@ $^
+ 
+ libcom32min.a : $(MINLIBOBJS)
+ 	rm -f $@
+Index: syslinux-6.04-pre2/com32/libutil/Makefile
+===================================================================
+--- syslinux-6.04-pre2.orig/com32/libutil/Makefile
++++ syslinux-6.04-pre2/com32/libutil/Makefile
+@@ -41,7 +41,7 @@ LNXLIBOBJS = $(patsubst %.o,%.lo,$(LIBOB
+ all: libutil.c32 libutil_lnx.a
+ 
+ libutil.elf: $(LIBOBJS)
+-	$(LD) $(LDFLAGS) -soname $(patsubst %.elf,%.c32,$(@F)) -o $@ $^
++	$(LD) $(LDFLAGS) -Wl,-soname $(patsubst %.elf,%.c32,$(@F)) -o $@ $^
+ 
+ libutil_lnx.a: $(LNXLIBOBJS)
+ 	rm -f $@
+Index: syslinux-6.04-pre2/com32/lua/src/Makefile
+===================================================================
+--- syslinux-6.04-pre2.orig/com32/lua/src/Makefile
++++ syslinux-6.04-pre2/com32/lua/src/Makefile
+@@ -51,7 +51,7 @@ CFLAGS += -DLUA_ANSI
+ all: $(MODULES) $(TESTFILES)
+ 
+ liblua.elf : $(LIBLUA_OBJS)
+-	$(LD) $(LDFLAGS) -shared -soname $(patsubst %.elf,%.c32,$(@F)) \
++	$(LD) $(LDFLAGS) -shared -Wl,-soname $(patsubst %.elf,%.c32,$(@F)) \
+ 		-o $@ $^
+ 
+ lua.elf : $(OBJS) $(LIBLUA) $(C_LIBS)
+Index: syslinux-6.04-pre2/core/Makefile
+===================================================================
+--- syslinux-6.04-pre2.orig/core/Makefile
++++ syslinux-6.04-pre2/core/Makefile
+@@ -158,9 +158,9 @@ NASM_ELF = elf
+ %.elf: %.o $(LIBDEP) $(LDSCRIPT) $(AUXLIBS)
+ 	$(LD) $(LDFLAGS) -pie -Bsymbolic \
+ 		-T $(LDSCRIPT) \
+-		--unresolved-symbols=report-all \
+-		-E --hash-style=gnu -M -o $@ $< \
+-		--start-group $(LIBS) $(subst $(*F).elf,lib$(*F).a,$@) --end-group \
++		-Wl,--unresolved-symbols=report-all \
++		-Wl,-E -Wl,--hash-style=gnu -Wl,-M -o $@ $< \
++		-Wl,--start-group $(LIBS) $(subst $(*F).elf,lib$(*F).a,$@) -Wl,--end-group \
+ 		> $(@:.elf=.map)
+ 	if [ `$(NM) -D -u $@ | wc -l` -ne 0 ]; then \
+ 		$(NM) -D -u $@ 1>&2; rm -f $@; false; fi
+Index: syslinux-6.04-pre2/memdisk/Makefile
+===================================================================
+--- syslinux-6.04-pre2.orig/memdisk/Makefile
++++ syslinux-6.04-pre2/memdisk/Makefile
+@@ -78,10 +78,10 @@ memdisk16.o: memdisk16.asm
+ 	$(NASM) -f bin $(NASMOPT) $(NFLAGS) $(NINCLUDE) -o $@ -l $*.lst $<
+ 
+ memdisk_%.o: memdisk_%.bin
+-	$(LD) --oformat elf32-i386 -r -b binary -o $@ $<
++	$(LD) -Wl,--oformat elf32-i386 -Wl,-r -Wl,-b,binary -o $@ $<
+ 
+ memdisk16.elf: $(OBJS16)
+-	$(LD) -Ttext 0 -o $@ $^
++	$(LD) -Wl,-Ttext,0 -o $@ $^
+ 
+ #memdisk32.elf: memdisk.ld $(OBJS32)
+ memdisk32.elf: $(ARCH)/memdisk.ld $(OBJS32)
+Index: syslinux-6.04-pre2/mk/com32.mk
+===================================================================
+--- syslinux-6.04-pre2.orig/mk/com32.mk
++++ syslinux-6.04-pre2/mk/com32.mk
+@@ -80,7 +80,7 @@ SFLAGS     = $(GCCOPT) $(GCCWARN) \
+ 	     -I$(topdir)/core/include
+ 
+ COM32LD	   = $(com32)/lib/$(ARCH)/elf.ld
+-LDFLAGS    = -m elf_$(ARCH) -shared --hash-style=gnu -T $(COM32LD)
++LDFLAGS    = -Wl,-m,elf_$(ARCH) -shared -Wl,--hash-style=gnu -T $(COM32LD)
+ LIBGCC    := $(shell $(CC) $(GCCOPT) --print-libgcc)
+ 
+ LNXCFLAGS  = -I$(com32)/libutil/include $(GCCWARN) -O -g \
+Index: syslinux-6.04-pre2/mk/elf.mk
+===================================================================
+--- syslinux-6.04-pre2.orig/mk/elf.mk
++++ syslinux-6.04-pre2/mk/elf.mk
+@@ -67,7 +67,7 @@ GCCOPT += -mregparm=3 -DREGPARM=3
+ endif
+ 
+ SFLAGS     = $(GCCOPT) -D__COM32__ -D__FIRMWARE_$(FIRMWARE)__ 
+-LDFLAGS    = -m elf_$(ARCH) -shared --hash-style=gnu -T $(com32)/lib/$(ARCH)/elf.ld --as-needed
++LDFLAGS    = -Wl,-m,elf_$(ARCH) -shared -Wl,--hash-style=gnu -T $(com32)/lib/$(ARCH)/elf.ld -Wl,--as-needed
+ LIBGCC    := $(shell $(CC) $(GCCOPT) --print-libgcc)
+ 
+ LNXCFLAGS  = -I$(com32)/libutil/include -W -Wall -O -g -D_GNU_SOURCE
+Index: syslinux-6.04-pre2/mk/embedded.mk
+===================================================================
+--- syslinux-6.04-pre2.orig/mk/embedded.mk
++++ syslinux-6.04-pre2/mk/embedded.mk
+@@ -54,7 +54,7 @@ GCCOPT    += $(call gcc_ok,-fvisibility=
+ 
+ LIBGCC    := $(shell $(CC) $(GCCOPT) --print-libgcc)
+ 
+-LD        += -m elf_$(ARCH)
++LD        += -Wl,-m,elf_$(ARCH)
+ 
+ # Note: use += for CFLAGS and SFLAGS in case something is set in MCONFIG.local
+ CFLAGS    += $(GCCOPT) -g $(GCCWARN) -Wno-sign-compare $(OPTFLAGS) $(INCLUDES)
+Index: syslinux-6.04-pre2/mk/lib.mk
+===================================================================
+--- syslinux-6.04-pre2.orig/mk/lib.mk
++++ syslinux-6.04-pre2/mk/lib.mk
+@@ -203,7 +203,7 @@ CORELIBOBJS = \
+ 	$(LIBENTRY_OBJS) \
+ 	$(LIBMODULE_OBJS)
+ 
+-LDFLAGS	= -m elf_$(ARCH) --hash-style=gnu -T $(com32)/lib/$(ARCH)/elf.ld
++LDFLAGS	= -Wl,-m,elf_$(ARCH) -Wl,--hash-style=gnu -T $(com32)/lib/$(ARCH)/elf.ld
+ 
+ .SUFFIXES: .c .o .a .so .lo .i .S .s .ls .ss .lss
+ 
+Index: syslinux-6.04-pre2/mk/syslinux.mk
+===================================================================
+--- syslinux-6.04-pre2.orig/mk/syslinux.mk
++++ syslinux-6.04-pre2/mk/syslinux.mk
+@@ -53,7 +53,7 @@ gcc_ok   = $(shell tmpf=gcc_ok.$$$$.tmp;
+ 		   then echo '$(1)'; else echo '$(2)'; fi; \
+ 		   rm -f $$tmpf)
+ 
+-LD	 = ld
++LD	 = gcc -nostdinc -fuse-ld=bfd
+ OBJDUMP	 = objdump
+ OBJCOPY  = objcopy
+ STRIP    = strip
diff --git a/meta/recipes-devtools/syslinux/syslinux_6.04-pre2.bb b/meta/recipes-devtools/syslinux/syslinux_6.04-pre2.bb
index e9dbefb930..48a17aaf0c 100644
--- a/meta/recipes-devtools/syslinux/syslinux_6.04-pre2.bb
+++ b/meta/recipes-devtools/syslinux/syslinux_6.04-pre2.bb
@@ -21,6 +21,7 @@ SRC_URI = "https://www.zytor.com/pub/syslinux/Testing/6.04/syslinux-${PV}.tar.xz
            file://0008-libinstaller-syslinuxext-implement-syslinux_patch_bo.patch \
            file://0009-linux-syslinux-implement-install_bootblock.patch \
            file://0001-install-don-t-install-obsolete-file-com32.ld.patch \
+           file://syslinux-link-with-gcc-wrapper.patch \
            "
 
 SRC_URI[md5sum] = "2b31c78f087f99179feb357da312d7ec"
@@ -60,7 +61,7 @@ do_compile() {
 	# Rebuild only the installer; keep precompiled bootloaders
 	# as per author's request (doc/distrib.txt)
 	oe_runmake CC="${CC} ${CFLAGS}" \
-                   LD="${LD}" LDFLAGS="${LDFLAGS}" \
+                   LD="${CCLD} -nostdlib -fuse-ld=bfd" LDFLAGS="${LDFLAGS}" \
                    OBJDUMP="${OBJDUMP}" \
                    OBJCOPY="${OBJCOPY}" \
                    AR="${AR}" \
@@ -71,7 +72,7 @@ do_compile() {
 }
 
 do_install() {
-	oe_runmake CC="${CC} ${CFLAGS}" LD="${LD}" \
+	oe_runmake CC="${CC} ${CFLAGS}" LD="${CCLD} -nostdlib -fuse-ld=bfd" \
                    OBJDUMP="${OBJDUMP}" \
                    OBJCOPY="${OBJCOPY}" \
                    AR="${AR}" \
-- 
2.24.0

